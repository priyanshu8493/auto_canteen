<script>
    // ... (keep all your existing functions the same) ...

    async function updateStats() {
        try {
            const response = await fetch('{{ url_for("stats", _external=False) }}');
            const data = await response.json();
            document.getElementById('total-faculty').textContent = data.total_faculty;
            document.getElementById('total-scans').textContent = data.total_scans;
            document.getElementById('today-scans').textContent = data.today_scans;
            updateConnectionStatus(false);
        } catch (error) {
            console.error('Error updating stats:', error);
            updateConnectionStatus(true);
        }
    }

    async function checkForNewScans() {
        try {
            const response = await fetch('{{ url_for("get_recent_scans", _external=False) }}');
            const scans = await response.json();
            if (scans.length > 0 && scans[0].timestamp > lastScanTimestamp) {
                addNewScanToList(scans[0]);
                lastScanTimestamp = scans[0].timestamp;
            }
        } catch (error) {
            console.error('Error checking for new scans:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Initialize lastScanTimestamp from the latest scan on the page
        if (document.querySelectorAll('.scan-item').length > 0) {
            fetch('{{ url_for("get_recent_scans", _external=False) }}').then(res => res.json()).then(scans => {
                if (scans.length > 0) lastScanTimestamp = scans[0].timestamp;
            });
        }

        // Enable voice on first interaction
        document.body.addEventListener('click', () => speak('Voice system activated for meal tracking'), { once: true });

        updateStats();
        setInterval(updateStats, 10000); // Update stats every 10 seconds

        // --- Socket.IO integration ---
        const script = document.createElement('script');
        script.src = '{{ url_for("static", filename="socket.io/socket.io.js", _external=False) }}';
        script.onload = () => {
            const socket = io();
            socket.on('connect', () => {
                updateConnectionStatus(false);
            });
            socket.on('disconnect', () => {
                updateConnectionStatus(true);
            });
            socket.on('new_scan', (scanData) => {
                addNewScanToList(scanData);
                lastScanTimestamp = scanData.timestamp;
            });
        };
        script.onerror = () => {
            updateConnectionStatus(true);
        };
        document.body.appendChild(script);
    });
</script>
