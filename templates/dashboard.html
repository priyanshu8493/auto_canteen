{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>ðŸ“Š Vendor Dashboard</h1>
        <p>Real-time faculty attendance monitoring</p>
    </div>
    
    <div class="stats" id="stats">
        <div class="stat-card">
            <div class="number" id="total-faculty">-</div>
            <div class="label">Total Faculty</div>
        </div>
        <div class="stat-card">
            <div class="number" id="total-scans">-</div>
            <div class="label">Total Scans</div>
        </div>
        <div class="stat-card">
            <div class="number" id="today-scans">-</div>
            <div class="label">Today's Scans</div>
        </div>
    </div>
    
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>Recent Scans</h2>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button onclick="testVoice()" class="btn" style="width: auto; padding: 8px 16px; font-size: 14px;">
                    ðŸ”Š Test Voice
                </button>
                <div id="connection-status" style="padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: bold; background: #d4edda; color: #155724;">
                    ðŸŸ¢ Polling Active
                </div>
            </div>
        </div>
        <div id="scan-list">
            {% if scans %}
                {% for scan in scans %}
                <div class="scan-item" data-scan-id="{{ scan.scan_id }}">
                    <h4>{{ scan.faculty_name }}</h4>
                    <div class="meta">
                        {{ scan.faculty_department }} â€¢ {{ scan.faculty_phone_number }}<br> Scanned at: {{ scan.scanned_at }}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="loading">No scans recorded yet...</div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Voice functionality
    let voiceEnabled = false;
    let lastProcessedScan = null;
    
    function speak(text) {
        console.log('Attempting to speak:', text);
        
        if ('speechSynthesis' in window) {
            // Cancel any ongoing speech
            speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 0.8;
            
            utterance.onerror = function(event) {
                console.error('Speech error:', event);
            };
            
            utterance.onstart = function(event) {
                console.log('Speech started:', text);
            };
            
            utterance.onend = function(event) {
                console.log('Speech completed');
            };
            
            try {
                speechSynthesis.speak(utterance);
                return true;
            } catch (error) {
                console.error('Speech synthesis failed:', error);
                return false;
            }
        } else {
            console.warn('Speech synthesis not supported in this browser');
            alert('Voice announcement: ' + text);
            return false;
        }
    }
    
    function enableVoice() {
        if (!voiceEnabled) {
            const success = speak("Voice system activated for attendance monitoring");
            if (success) {
                voiceEnabled = true;
                console.log('âœ… Voice enabled successfully');
            }
        }
    }
    
    function testVoice() {
        console.log('ðŸ”Š Test voice button clicked');
        enableVoice();
        setTimeout(() => {
            speak("Voice test successful. Faculty attendance system is ready.");
        }, 100);
    }
    
    // Polling-based real-time updates
    let lastScanTimestamp = 0;
    
    function checkForNewScans() {
        fetch('/api/recent-scans')
            .then(response => response.json())
            .then(scans => {
                if (scans.length > 0) {
                    const latestScan = scans[0];
                    
                    // Check if this is a new scan
                    if (latestScan.timestamp > lastScanTimestamp) {
                        lastScanTimestamp = latestScan.timestamp;
                        
                        // Only process if this is not the initial load
                        if (lastProcessedScan !== null) {
                            addNewScanToList(latestScan);
                            announceNewScan(latestScan);
                        }
                        
                        lastProcessedScan = latestScan.scan_id;
                    }
                }
                
                // Update stats
                updateStats();
            })
            .catch(error => {
                console.error('Error checking for new scans:', error);
                updateConnectionStatus('error', 'ðŸ”´ Connection Error');
            });
    }
    
    function addNewScanToList(scanData) {
        const scanList = document.getElementById('scan-list');
        
        // Check if scan already exists
        const existing = document.querySelector(`[data-scan-id="${scanData.scan_id}"]`);
        if (existing) {
            return; // Don't duplicate
        }
        
        // Create new scan item
        const newScanItem = document.createElement('div');
        newScanItem.className = 'scan-item new-scan';
        newScanItem.setAttribute('data-scan-id', scanData.scan_id);
        newScanItem.innerHTML = `
            <h4>${scanData.faculty_name}</h4>
            <div class="meta">
                ${scanData.faculty_department} â€¢ ${scanData.faculty_phone_number}<br> Scanned at: ${scanData.scanned_at}
            </div>
        `;
        
        // Remove loading message if exists
        const loadingMessage = scanList.querySelector('.loading');
        if (loadingMessage) {
            loadingMessage.remove();
        }
        
        // Insert at the top
        if (scanList.firstChild) {
            scanList.insertBefore(newScanItem, scanList.firstChild);
        } else {
            scanList.appendChild(newScanItem);
        }
        
        // Remove animation class after 2 seconds
        setTimeout(() => {
            newScanItem.classList.remove('new-scan');
        }, 2000);
        
        console.log('âœ… New scan added to dashboard:', scanData.faculty_name);
    }
    
    function announceNewScan(scanData) {
        if (voiceEnabled) {
            const time = new Date(scanData.scanned_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const message = `Faculty ${scanData.faculty_name} scanned successfully at ${time}`;
            
            setTimeout(() => {
                speak(message);
            }, 300);
        } else {
            console.log('ðŸ”‡ Voice not enabled. Click "Test Voice" button to enable.');
        }
    }
    
    function updateConnectionStatus(status, message) {
        const statusElement = document.getElementById('connection-status');
        if (statusElement) {
            statusElement.textContent = message;
            statusElement.style.background = status === 'connected' ? '#d4edda' : 
                                           status === 'polling' ? '#d4edda' : 
                                           status === 'connecting' ? '#fff3cd' : '#f8d7da';
            statusElement.style.color = status === 'connected' ? '#155724' : 
                                       status === 'polling' ? '#155724' :
                                       status === 'connecting' ? '#856404' : '#721c24';
        }
    }
    
    // Update statistics
    function updateStats() {
        fetch('/api/stats')
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-faculty').textContent = data.total_faculty;
                document.getElementById('total-scans').textContent = data.total_scans;
                document.getElementById('today-scans').textContent = data.today_scans;
                
                updateConnectionStatus('polling', 'ðŸŸ¢ Polling Active');
            })
            .catch(error => {
                console.error('Error updating stats:', error);
                updateConnectionStatus('error', 'ðŸ”´ Connection Error');
            });
    }
    
    // Initialize the dashboard
    function initializeDashboard() {
        console.log('ðŸš€ Dashboard initializing...');
        
        // Set initial lastScanTimestamp to current time to avoid processing old scans as new
        if (document.querySelectorAll('.scan-item').length > 0) {
            // If there are existing scans, get the timestamp of the most recent one
            fetch('/api/recent-scans')
                .then(response => response.json())
                .then(scans => {
                    if (scans.length > 0) {
                        lastScanTimestamp = scans[0].timestamp;
                        lastProcessedScan = scans[0].scan_id;
                    }
                    console.log('ðŸ“Š Dashboard initialized with existing scans');
                })
                .catch(error => console.error('Error initializing:', error));
        }
        
        // Enable voice on first click anywhere
        document.addEventListener('click', enableVoice, { once: true });
        
        // Start polling for new scans every 2 seconds
        setInterval(checkForNewScans, 2000);
        
        // Update stats immediately and then every 10 seconds
        updateStats();
        setInterval(updateStats, 10000);
        
        console.log('âœ… Dashboard fully loaded and polling started');
    }
    
    // Start everything when page loads
    document.addEventListener('DOMContentLoaded', initializeDashboard);
</script>
{% endblock %}